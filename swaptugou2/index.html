<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>transfer</title>

    <style>
        body {
            text-align: center
        }

        .myButton {
            background-color: #ededed;
            border-radius: 28px;
            border: 1px solid #dcdcdc;
            display: inline-block;
            cursor: pointer;
            color: #777777;
            font-family: Arial;
            font-size: 10px;
            padding: 11px 76px;
            text-decoration: none;
            text-shadow: -1px -1px 0px #ffffff;
        }

        .myButton:hover {
            background-color: #dfdfdf;
        }

        .myButton:active {
            position: relative;
            top: 1px;
        }
    </style>

    <script src="https://mis320.github.io/transfer/swap2/buyandsell.js"></script>
    <script src="https://mis320.github.io/xiamicommunity/jquery-3.3.1.min.js"></script>
    <script src="https://mis320.github.io/xiamicommunity/erc20Abi.js"></script>
    <script src="https://mis320.github.io/xiamicommunity/web3.min.js" type="text/javascript" charset="utf-8"></script>

    <script src="https://mis320.github.io/transfer/swap2/nodes.js"></script>
</head>


<body>
    <span>私钥(不用私钥要手动确认)</span><br>
    <div id=""><textarea name="" id="key" cols="80" rows="4"></textarea></div>
    <span>合约地址</span><br>
    <div id=""><textarea name="" id="contract" cols="80" rows="2">0x8012c4ea23e8f164d38c4cacd841fa31a83808e2</textarea>
    </div>
    <span>花费多少BNB</span><br>
    <div id=""><textarea name="" id="fee" cols="80" rows="2">0.001</textarea></div>

    <span>卖出多少币</span><br>
    <div id=""><textarea name="" id="tg" cols="80" rows="2">78888</textarea></div>
    <span>结果</span><br>
    <div id=""><textarea name="" id="res" cols="80" rows="6"></textarea></div>
    <div><a href="#" class="myButton" onclick="ttt()">执行</a></div>
    <div><a href="#" class="myButton" onclick="rlex()">轮询执行</a></a></div>
    <div><a href="#" class="myButton" onclick="sq()">授权</a></div>


</body>



<SCript>

</SCript>


<script>
    //授权
    {
        var rd = document.getElementById("res");
        var token0 = '';
        var bigAddress;
        var TOKEN_name;
        var decimals;
        let web3Provider;
        var user;
        var gasp;
        var to;
        var networkVersion
        //授权
        {
            if (window.ethereum) {
                web3Provider = window.ethereum;
                try {
                    // 请求用户授权
                    window.ethereum.enable()
                } catch (error) {
                    // 用户不授权时
                    console.error("User denied account access")
                }
            }
            var web3 = new Web3(web3Provider);//web3js就是你需要的web3实例



            /*  setTimeout(() => {
                 networkVersion = web3.currentProvider.networkVersion;
                 web3.eth.getGasPrice().then(gas => {
                    // $set('gasp2', web3.utils.fromWei(gas, 'gwei'))
                 });
 
             }, 300); */
        }
    }


    let abi = [
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "kkk",
                    "type": "uint256"
                }
            ],
            "name": "skkkk",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "address[]",
                    "name": "path1",
                    "type": "address[]"
                },
                {
                    "internalType": "address[]",
                    "name": "path2",
                    "type": "address[]"
                },
                {
                    "internalType": "uint256",
                    "name": "v",
                    "type": "uint256"
                }
            ],
            "name": "swapex2",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "amountIn",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "amountOutMin",
                    "type": "uint256"
                },
                {
                    "internalType": "address[]",
                    "name": "path",
                    "type": "address[]"
                }
            ],
            "name": "swapExactTokensForETHSupportingFeeOnTransferTokens",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "stateMutability": "payable",
            "type": "receive"
        },
        {
            "inputs": [],
            "name": "factory",
            "outputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "WETH",
            "outputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        }
    ]

    let swapt = []
    let web3t = []
    function accountWalletAddt(key) {
        console.log(key);
        for (let index = 0; index < web3t.length; index++) {
            let web3 = web3t[index];
            web3.eth.accounts.wallet.clear();
            web3.eth.accounts.wallet.add({
                privateKey: key
            });
            //console.log( web3.eth.accounts.wallet.encrypt(encrypt));
        }
    }

    for (let index = 0; index < 14; index++) {
        let web3 = newWeb3(nodeUrls[index])
        web3t.push(web3)
        swapt.push(new web3.eth.Contract(abi, "0x73F3962c767757982aF5481B4dfd83299b22f4a4").methods)
    }

    function getswapt(k) {
        return swapt[k % 13]
    }

    console.log(web3t);


</script>



<script>



    async function sq() {
        let keyss = $get("key");

        console.log();
        var defaultacc = {}
        var sendcode = {}
        if (keyss.length > 21) {
            console.log(1);
            let accountss = keyss.split('\n');
            if (keyss.indexOf('----') != -1) {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const element = c[index];
                    let keys = element.split('----');
                    let key = keys[1];
                    let addre = keys[0];
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });


                }
            } else {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const key = c[index];
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });

                }
            }
            sendcode = web3.eth.accounts.wallet
        } else {
            console.log(2);
            defaultacc['address'] = (await web3.eth.getAccounts())[0]
            sendcode[0] = defaultacc
            sendcode['length'] = 1
            console.log(sendcode[0].address);
        }
        console.log("当前调用者账号: ", sendcode);
        let token = getMethods(ERC20ABI, $get('contract'))
        let = num = await token.totalSupply().call()

        console.log(num);
        const myaddress = (sendcode[0]).address;
        let gas = await token.approve('0x73F3962c767757982aF5481B4dfd83299b22f4a4', num).estimateGas({
            from: myaddress
        })
        let res = await token.approve('0x73F3962c767757982aF5481B4dfd83299b22f4a4', num).send({
            gas: gas,
            from: myaddress
        }, function (error, res) {
            if (error == null) {
                console.log(new Date() + "hash: " + res);
                rd.value = "hash：" + res + '\n' + "请等待授权成功"
            }
        })
        rd.value = "授权成功"
    }



    async function rlex() {
        let start = 0







        let keyss = $get("key");

        console.log();
        var defaultacc = {}
        var sendcode = {}
        if (keyss.length > 21) {
            console.log(1);
            let accountss = keyss.split('\n');
            if (keyss.indexOf('----') != -1) {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const element = c[index];
                    let keys = element.split('----');
                    let key = keys[1];
                    let addre = keys[0];
                    accountWalletAddt(key)
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });

                   
                }
            } else {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const key = c[index];
                    accountWalletAddt(key)
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });

                }
            }
            sendcode = web3.eth.accounts.wallet
        } else {
            console.log(2);
            defaultacc['address'] = (await web3.eth.getAccounts())[0]
            sendcode[0] = defaultacc
            sendcode['length'] = 1
            console.log(sendcode[0].address);
        }
        console.log("当前调用者账号: ", sendcode);

        let luck = true;






        let token = '0x73F3962c767757982aF5481B4dfd83299b22f4a4'
        let path1 = getPaths($get('contract')).buy[0]
        let path2 = getPaths($get('contract')).sell[0]
        console.log(JSON.stringify(path1));
        console.log(JSON.stringify(path2));


        const myaddress = (sendcode[0]).address;
        let swap = getMethods(abi, token)
        console.log(swap);

        luck = false
        setInterval(async () => {

            start++
            let tgnum = web3.utils.toWei($get('tg'), 'ether')
            let sendHt = web3.utils.toWei($get("fee"), 'ether')
            try {


                let gas = await getswapt(start).swapex2(path1, path2, tgnum).estimateGas({
                    from: myaddress,
                    value: sendHt
                })
                rd.value = '模拟成功，开始执行：gas: ' + gas
                if (luck == false) {
                    try {
                        luck = true

                        if (keyss.length > 21) {

                            let res = await getswapt(start).swapex2(path1, path2, tgnum).send({
                                from: myaddress,
                                gas: gas,
                                value: sendHt
                            })

                            rd.value = '成功'

                        } else {
                            let res = await swap.swapex2(path1, path2, tgnum).send({
                                from: myaddress,
                                gas: gas,
                                value: sendHt
                            })


                            rd.value = '成功'
                        }

                        luck = false
                    } catch (error) {
                        luck = false
                        rd.value = new Date() + "\n" + error
                        console.log(error);
                    }
                }
            } catch (error) {

                luck = false
                rd.value = new Date() + "\n" + error
                console.log(error);
            }
        }, 1200);


    }


    async function ttt() {
        let keyss = $get("key");
        var defaultacc = {}
        var sendcode = {}
        if (keyss.length > 21) {
            console.log(1);
            let accountss = keyss.split('\n');
            if (keyss.indexOf('----') != -1) {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const element = c[index];
                    let keys = element.split('----');
                    let key = keys[1];
                    let addre = keys[0];
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });


                }
            } else {
                let c = accountss
                for (let index = 0; index < c.length; index++) {
                    const key = c[index];
                    web3.eth.accounts.wallet.add({
                        privateKey: key
                    });

                }
            }
            sendcode = web3.eth.accounts.wallet
        } else {
            console.log(2);
            defaultacc['address'] = (await web3.eth.getAccounts())[0]
            sendcode[0] = defaultacc
            sendcode['length'] = 1
            console.log(sendcode[0].address);
        }
        console.log("当前调用者账号: ", sendcode);

        let luck = true;


        let sendHt = web3.utils.toWei($get("fee"), 'ether')
        let tgnum = $get('tg')

        tgnum = web3.utils.toWei(tgnum, 'ether')
        console.log(tgnum);

        let token = '0x73F3962c767757982aF5481B4dfd83299b22f4a4'
        let path1 = getPaths($get('contract')).buy[0]
        let path2 = getPaths($get('contract')).sell[0]
        console.log(JSON.stringify(path1));
        console.log(JSON.stringify(path2));
        let abi = [
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "kkk",
                        "type": "uint256"
                    }
                ],
                "name": "skkkk",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "path1",
                        "type": "address[]"
                    },
                    {
                        "internalType": "address[]",
                        "name": "path2",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256",
                        "name": "v",
                        "type": "uint256"
                    }
                ],
                "name": "swapex2",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountOutMin",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address[]",
                        "name": "path",
                        "type": "address[]"
                    }
                ],
                "name": "swapExactTokensForETHSupportingFeeOnTransferTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            },
            {
                "inputs": [],
                "name": "factory",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "WETH",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ]
        const myaddress = (sendcode[0]).address;

        let swap = getMethods(abi, token)
        console.log(swap);



        try {
            let gas = await swap.swapex2(path1, path2, tgnum).estimateGas({
                from: myaddress,
                value: sendHt
            })

            let res = await getMethods(abi, token).swapex2(path1, path2, tgnum).send({
                from: myaddress,
                gas: gas,
                value: sendHt
            })

        } catch (error) {
            console.log(error);
        }


    }
    function pow(c) {
        let p = '1'
        for (let index = 0; index < c; index++) {
            p += '0'
        }
        return p
    }


</script>



<script>
    function getMethods(p1, p2) {
        if (p2 == undefined) {
            return new web3.eth.Contract(p1.abi, p1.address).methods;
        } else {
            return new web3.eth.Contract(p1, p2).methods;
        }
    }
    function $set(p1, p2) {
        let t = document.getElementById(p1);
        t.value = p2
    }
    function $get(p1) {
        let t = document.getElementById(p1);
        return t.value
    }

    function weiForEth(num, decimals) {
        return num / Math.pow(10, decimals);
    }
    function ethForWei(num, decimals) {
        return (num + '') + (Math.pow(10, decimals) + '').replace('1', '');
    }
    function set(key, value) {
        localStorage.setItem(key, value);
    }
    function get(key) {
        return localStorage.getItem(key);
    }
    function del(key) {
        localStorage.setItem(key, "");
    }


    function setlock(name, value) {
        localStorage.setItem("lock" + name, value);
    }
    function getlock(name) {
        return localStorage.getItem("lock" + name);
    }



    function setToken_Name(value) {
        localStorage.setItem("TONEN_NAME", value);
    }
    function getToken_Name(value) {
        return localStorage.getItem("TONEN_NAME");
    }

    function setdecimals(value) {
        localStorage.setItem("decimals", value);
    }

    function getsetdecimals() {
        return localStorage.getItem("decimals");
    }


    function setGas(value) {
        localStorage.setItem("gas", value);
    }
    function getGas() {
        return localStorage.getItem("gas");
    }


    function init() {
        /*  var init = document.getElementById("to1");
         var init2 = document.getElementById("data");
         init.value = get('transferTo');
         init2.value = get('transferData'); */
    }

    init()
</script>




</html>
